---
title: "VIQ - Laboratorio 5"
date: 2022-05-05
output: html_notebook
---

### Obiettivi

1.  Usare ggplot per creare grafici

### Strumento

R ed RStudio, in particolare la libreria ggplot (parte di tidyverse): 

```{r import delle librerie,include=FALSE}
library(tidyverse)
```

### Dataset

Utilizziamo il dataset pubblico sui dati ISTAT con periodo di riferimento GENNAIO-FEBBRAIO 2021, pubblicati in data 06 APRILE 2021:

https://www.istat.it/it/archivio/256254

Usiamo il dataframe ripulito secondo le indicazioni dello scorso laboratorio.
Il file `TidyIstat.R` contiene il codice per scaricare e ripulire i dati, che vengono salvati in `istat_occupazione.RDS` (formato compresso di R) che può essere letto tramite il metodo `read_rds()`.

```{r leggi dati, }
istat <- read_rds("istat_occupazione.RDS")
istat
```

- Mostrare l'andamento del tasso di disosccupazione di Femmine, Maschi e Generale. 
  - Usare prima dei punti colorati in modo diverso:

```{r}
## DA COMPLETARE

```

  - e poi usare delle linee:

```{r}
## DA COMPLETARE

```

  - Riflessione: quale dei due tipi di layer è più adatto?

## Scale 

La visualizzazione può essere personalizzata prima di tutto tramite delle opportune scale che fanno corrispondere i valori delle variabili a delle diverse caratteristiche visuali.

### Scala colore

- Modificare il diagramma a linee precedente in modo che i colori utilizzati per Femmine, Maschi e Generale siano rispettivamente rosa, blu e grigio (`pink`,`skyblue`, `gray50`).

```{r}
## DA COMPLETARE

```

### Altre scale

È possibile utilizzare delle scale per qualsiasi aspetto estetico, ad esempio per `geom_line()` è possibile specificare l'estetica `linetype` per il tipo di linea:

```{r tipi di linea, fig.width=3, fig.height=3, echo=FALSE}
ggplot(data.frame(y=factor(1:6),x=0),aes(x,y))+
  geom_text(aes(label=y),vjust=0,size=6)+
  geom_hline(yintercept=1:6,linetype=1:6)+
  theme_void()
```

- Modificare il grafico del punto precedente in modo che i valori per Maschi e Femmine siano a tratto continuo, mentre quelli Generali siano a punto e linea.

  - Suggerimento: si utilizzi la funzione `scale_linetype_manual()`.

```{r}
## DA COMPLETARE

```

### Scala posizione

La scala verticale rappresenta dei tassi (<1) che potrebbero essere rappresentati meglio come percentuali. È possibile utilizzare la funzione `scale_y_continuous()` per specificare come
stampare le etichette. In particolare è possibile utilizzare il parametro `labels` a cui passare una funzione che
- prende i valori corrispondenti alle etichette 
- resituisce l'etichetta (ad es. 0.12 dovrebbe diventare "12%")


- Modificare il grafico precedente in modo da stampare correttamente le percentuali sull'asse y.

  - Suggerimento: è possibile scrivere esplicitamente la funzione oppure usare `scales::percent` che è una funzione già definita.

```{r}
## DA COMPLETARE

```

## Direct labeling

- Rimuovere la legenda e sostituirla con un direct labeling.
  - Suggerimento: per rimuovere la legenda legata ad una scale, usare `guide="none"` nella funzione di scala (dei colori)
  - Suggerimento: per allineare il testo alla destra dell'estremo destro delle linee, è possibile usare il parametro `hjust=0`, ed il parametro `nudge_x` per distanziarlo ulteriormente.


```{r}
## DA COMPLETARE

```


## Serie multiple

- Mostrare l'andamento del tasso di disoccupazione generale e quello giovanile

  - Suggerimento: per lasciare spazio sufficiente all'etichetta è possibile usare il parametro `expand` della funzione `scale_x_date` che riceve il risultato della funzione `expansion()` (si veda Help per ulteriori indicazioni).
--
```{r}
## DA COMPLETARE

```


## Annotazioni

- Modificare il grafico precedente in modo da mostrare il valore massimo, il valore minimo ed il valore finale (assieme alla *direct label*) di ciascuna serie.

```{r}
## DA COMPLETARE

```

## Aprossimazioni

* Scrivere una funzione che dato un vettore `v` di numeri ed un intero `n`, produca un vettore (di pari lunghezza) contenente la media mobile su `n` elementi. 
Visto che la media mobile non è definita per i primi $n/2$ elementi, il risultato deve contenere $\lfloor{(n-1)/2}\rfloor$ valori `NA` in testa e $\lfloor{n/2}\rfloor$ `NA` in coda.
Esenpio con n=3:
------------------ ---- --- ------- ------- --- --- ------- ------- ------- ----
 **v**              2    5     2       6     6   6     3       4       1     6  

 **media mobile**   NA   3   4.333   4.667   6   5   4.333   2.667   3.667   NA 
------------------ ---- --- ------- ------- --- --- ------- ------- ------- ----

```{r}
## DA COMPLETARE

```

- Rappresentare l'andamento della disoccupazione giovanile con aggiunta la media mobile a tre mesi.

```{r}
## DA COMPLETARE

```

- Rappresentare l'andamento della disoccupazione giovanile con aggiunta l'interpolazione LOESS, tramite la funzione `geom_smooth()`.

```{r}
## DA COMPLETARE

```


## Valori derivati

Dalla [nota metodologica ISTAT](https://www.istat.it/it/files//2021/04/CS_Occupati_disoccupati_FEBBRAIO_2021.pdf) sappiamo che

- Occupati: persone (15-89 anni) che hanno lavorato o sono in permesso
- Disoccupati: persone (15-74 anni) che sono in cerca di lavoro
- Popolazione: persone nella fascia d'età considerata
- Attivi: Occupati + Disoccupati

Il tasso di attività è dato da:

$$t_A = \frac{Attivi}{Popolazione}$$

Il tasso di occupazione è dato da:

$$t_O = \frac{Occupati}{Popolazione}$$

Il tasso di disoccupazione è dato da:

$$t_D = \frac{Disoccupati}{Attivi}$$

A partire dai valori precedentemente definiti e forniti dall'ISTAT, possiamo quindi calcolare:

La proporzione di disoccupati sulla popolazione totale:

$$p_D = \frac{Disoccupati}{Popolazione} = t_D \cdot t_A$$

La proporzione di inattivi (non attivi) sulla popolazione totale.

$$p_I = \frac{Inattivi}{Popolazione} = 1 - t_A$$

Le popolazioni di riferimento per Occupati e Disoccupati non sono esattamente le stesse, ma la differenza è minima, perciò abbiamo:

$$ p_D + t_O + p_I \approx 1 $$

- Verificare che la distribuzione della somma tra Tasso di Occupazione, Proporzione di Disoccupati e Proporzione Inattivi sia circa 1 (usando un boxplot) per M, F e MF.

```{r}
## DA COMPLETARE

```

**Riflessione** lo scostamento è dovuto alla non esatta corrispondenza tra le popolazioni, in particolare è tanto più ampio quando più c'è una parte di occupati nella popolazione tra 74 e 89 anni.

- Modificare il diagramma precedente usando un violin plot sopra il quale riportare i punti relativi ai singoli valori.
  - usare il parametro `position="jitter"` per sparpagliare in maniera casuale i punti, evitando così di averli tutti allineati e sovrapposti.

```{r}
## DA COMPLETARE

```


- Mostrare con un diagramma ad area l'andamento delle tre componenti della somma nel corso del periodo di osservazione per la popolazione generale (MF).

```{r}
## DA COMPLETARE

```
